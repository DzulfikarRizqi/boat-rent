<?xml version="1.0" encoding="utf-8"?>
<Window x:Class="CobaHW7.ForecastWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:CobaHW7.ViewModels"
        xmlns:local="clr-namespace:CobaHW7"
        xmlns:oxy="http://oxyplot.org/wpf"
        mc:Ignorable="d"
        Title="Forecast Cuaca" Height="1080" Width="1920"
        WindowStartupLocation="CenterScreen"
        WindowState="Maximized"
        Background="#F5F7FB">

    <Window.Resources>
        <local:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
        <local:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <local:ChanceOfRainToBrushConverter x:Key="ChanceOfRainToBrushConverter"/>
    </Window.Resources>

    <Window.DataContext>
        <vm:ForecastViewModel/>
    </Window.DataContext>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Border Grid.Row="0" Background="#1976D2" Padding="20,15">
            <DockPanel LastChildFill="False">
                <TextBlock Text="Forecast Cuaca 7 Hari"
                           Foreground="White" FontWeight="Bold" FontSize="20"
                           VerticalAlignment="Center"/>
                <TextBlock DockPanel.Dock="Left" Text="{Binding ForecastData.Location.Name}"
                           Foreground="White" FontSize="16" Margin="20,0,0,0"
                           VerticalAlignment="Center"/>
                <Button DockPanel.Dock="Right" Content="â† Kembali ke Dashboard" Padding="15,8"
                        Background="White" Foreground="#1976D2" FontWeight="SemiBold"
                        BorderThickness="0" Click="BtnBack_Click"/>
            </DockPanel>
        </Border>

        <!-- Content -->
        <ScrollViewer Grid.Row="1" Padding="20">
            <StackPanel>
                <!-- Loading State -->
                <StackPanel Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}"
                           HorizontalAlignment="Center" VerticalAlignment="Center" Margin="0,100,0,0">
                    <TextBlock Text="Memuat data forecast..." Foreground="#666" FontSize="16"/>
                </StackPanel>

                <!-- Error State -->
                <Border Visibility="{Binding HasError, Converter={StaticResource BooleanToVisibilityConverter}}"
                       Background="#FFEBEE" BorderBrush="#D32F2F" BorderThickness="1"
                       Padding="15" CornerRadius="8" Margin="0,0,0,20">
                    <TextBlock Text="{Binding ErrorMessage}" Foreground="#D32F2F" FontSize="14"/>
                </Border>

                <!-- Chart Section -->
                <StackPanel Visibility="{Binding ForecastData, Converter={StaticResource NullToVisibilityConverter}}"
                           Margin="0,0,0,30">
                    <!-- Tab Selection -->
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,15">
                        <Button Content="Suhu" Padding="20,8"
                               Command="{Binding SelectTemperatureTabCommand}"
                               Foreground="#666" Background="Transparent" BorderThickness="0"
                               FontWeight="Bold" FontSize="13">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding SelectedChartType}" Value="Temperature">
                                            <Setter Property="Foreground" Value="#FF9800"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>

                        <Separator Width="1" Margin="10,0" Background="#E0E0E0"/>

                        <Button Content="Presipitasi" Padding="20,8" Margin="10,0,0,0"
                               Command="{Binding SelectPrecipitationTabCommand}"
                               Foreground="#666" Background="Transparent" BorderThickness="0"
                               FontWeight="Bold" FontSize="13">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding SelectedChartType}" Value="Precipitation">
                                            <Setter Property="Foreground" Value="#2196F3"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>

                        <Separator Width="1" Margin="10,0" Background="#E0E0E0"/>

                        <Button Content="Angin" Padding="20,8" Margin="10,0,0,0"
                               Command="{Binding SelectWindTabCommand}"
                               Foreground="#666" Background="Transparent" BorderThickness="0"
                               FontWeight="Bold" FontSize="13">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding SelectedChartType}" Value="Wind">
                                            <Setter Property="Foreground" Value="#4CAF50"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                    </StackPanel>

                    <!-- OxyPlot Chart -->
                    <Border Background="White" BorderBrush="#E0E0E0" BorderThickness="1"
                           CornerRadius="8" Padding="20" Margin="0,0,0,20" Height="280">
                        <Border.Effect>
                            <DropShadowEffect BlurRadius="5" ShadowDepth="1" Opacity="0.08"/>
                        </Border.Effect>
                        <oxy:PlotView Model="{Binding ForecastPlotModel}" Background="White"/>
                    </Border>

                    <!-- Hourly Breakdown (8 slots) -->
                    <TextBlock Text="Forecast Per 3 Jam" Foreground="#333" FontSize="13"
                              FontWeight="Bold" Margin="0,0,0,10"/>
                    <ItemsControl ItemsSource="{Binding SelectedDay.Hours}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel Orientation="Horizontal"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Visibility="{Binding RelativeSource={RelativeSource PreviousData}, Path=IsVisible, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=3}">
                                    <!-- This will show every 3rd hour -->
                                </StackPanel>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>

                <!-- 7-Day Forecast Section -->
                <StackPanel Visibility="{Binding SevenDayForecast, Converter={StaticResource NullToVisibilityConverter}}"
                           Margin="0,0,0,0">
                    <TextBlock Text="Forecast 7 Hari" Foreground="#333" FontSize="14"
                              FontWeight="Bold" Margin="0,0,0,15"/>
                    <ItemsControl ItemsSource="{Binding SevenDayForecast}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Orientation="Horizontal"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Background="White" Padding="12" Margin="0,0,8,0" CornerRadius="6"
                                       BorderBrush="#E0E0E0" BorderThickness="1" MinWidth="100">
                                    <Border.Effect>
                                        <DropShadowEffect BlurRadius="3" ShadowDepth="1" Opacity="0.08"/>
                                    </Border.Effect>
                                    <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                        <TextBlock Text="{Binding DayLabel}" Foreground="#333" FontWeight="Bold"
                                                  FontSize="12" TextAlignment="Center" Margin="0,0,0,8"/>
                                        <TextBlock Text="{Binding WeatherIcon}" FontSize="24"
                                                  HorizontalAlignment="Center" Margin="0,0,0,8"/>
                                        <TextBlock Foreground="#666" FontSize="11" TextAlignment="Center" Margin="0,0,0,4">
                                            <Run Text="{Binding MaxTemp}"/>
                                            <Run Text="Â°"/><Run Text=" / "/><Run Text="{Binding MinTemp}"/><Run Text="Â°"/>
                                        </TextBlock>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>

                <!-- Day Selection -->
                <StackPanel Visibility="{Binding ForecastData, Converter={StaticResource NullToVisibilityConverter}}"
                           Margin="0,0,0,20">
                    <TextBlock Text="Pilih Hari untuk Forecast Detil" Foreground="#333" FontSize="14"
                              FontWeight="Bold" Margin="0,0,0,10"/>
                    <Border BorderBrush="#E0E0E0" BorderThickness="1" CornerRadius="8" ClipToBounds="True">
                        <ListBox ItemsSource="{Binding ForecastDays}" SelectedItem="{Binding SelectedDay}"
                                Background="White" BorderBrush="Transparent" BorderThickness="0"
                                Height="80" ScrollViewer.HorizontalScrollBarVisibility="Auto"
                                ScrollViewer.VerticalScrollBarVisibility="Disabled">
                        <ListBox.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Orientation="Horizontal"/>
                            </ItemsPanelTemplate>
                        </ListBox.ItemsPanel>
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Border Background="White" Padding="15" Margin="5" CornerRadius="6"
                                       BorderBrush="#E0E0E0" BorderThickness="1" MinWidth="150">
                                    <Border.Style>
                                        <Style TargetType="Border">
                                            <Setter Property="Background" Value="White"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsSelected, RelativeSource={RelativeSource AncestorType=ListBoxItem}}"
                                                            Value="True">
                                                    <Setter Property="Background" Value="#E3F2FD"/>
                                                    <Setter Property="BorderBrush" Value="#1976D2"/>
                                                    <Setter Property="BorderThickness" Value="2"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Border.Style>
                                    <StackPanel>
                                        <TextBlock Text="{Binding Date, StringFormat=dd/MM/yyyy}"
                                                  Foreground="#333" FontWeight="Bold" FontSize="12"/>
                                        <TextBlock Text="{Binding Day.Condition.Text}"
                                                  Foreground="#666" FontSize="11" Margin="0,4,0,0"/>
                                        <TextBlock Foreground="#1976D2" FontWeight="Bold" Margin="0,4,0,0">
                                            <Run Text="{Binding Day.MaxTempC, StringFormat=N0}"/>
                                            <Run Text="Â° / "/>
                                            <Run Text="{Binding Day.MinTempC, StringFormat=N0}"/>
                                            <Run Text="Â°"/>
                                        </TextBlock>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                        </ListBox>
                    </Border>
                </StackPanel>

                <!-- Hourly Forecast -->
                <StackPanel Visibility="{Binding SelectedDay, Converter={StaticResource NullToVisibilityConverter}}"
                           Margin="0,0,0,30">
                    <TextBlock Text="Forecast Per Jam" Foreground="#333" FontSize="14"
                              FontWeight="Bold" Margin="0,0,0,10"/>
                    <ItemsControl ItemsSource="{Binding SelectedDay.Hours}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel Orientation="Horizontal"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Background="White" Padding="12" Margin="8" CornerRadius="8"
                                       BorderBrush="#E0E0E0" BorderThickness="1" Width="140">
                                    <Border.Effect>
                                        <DropShadowEffect BlurRadius="5" ShadowDepth="1" Opacity="0.1"/>
                                    </Border.Effect>
                                    <StackPanel>
                                        <TextBlock Text="{Binding Time, StringFormat=HH:mm}"
                                                  Foreground="#1976D2" FontWeight="Bold" FontSize="12"/>
                                        <TextBlock Text="{Binding Condition.Text}"
                                                  Foreground="#666" FontSize="10" Margin="0,6,0,0"
                                                  TextWrapping="Wrap"/>
                                        <TextBlock FontSize="16" FontWeight="Bold" Foreground="#333" Margin="0,8,0,0">
                                            <Run Text="{Binding TempC, StringFormat=N0}"/>
                                            <Run Text="Â°"/>
                                        </TextBlock>
                                        <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                                            <TextBlock FontSize="10" Foreground="#666">
                                                <Run Text="ðŸ’¨ "/>
                                                <Run Text="{Binding WindKph, StringFormat=N0}"/>
                                                <Run Text="kph"/>
                                            </TextBlock>
                                        </StackPanel>
                                        <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                                            <TextBlock FontSize="10" Foreground="#666">
                                                <Run Text="ðŸ’§ "/>
                                                <Run Text="{Binding Humidity}"/>
                                                <Run Text="%"/>
                                            </TextBlock>
                                        </StackPanel>
                                        <TextBlock Foreground="{Binding ChanceOfRain, Converter={StaticResource ChanceOfRainToBrushConverter}}"
                                                  FontSize="10" FontWeight="Bold" Margin="0,4,0,0">
                                            <Run Text="ðŸŒ§ "/>
                                            <Run Text="{Binding ChanceOfRain}"/>
                                            <Run Text="% hujan"/>
                                        </TextBlock>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </StackPanel>
        </ScrollViewer>
    </Grid>
</Window>
